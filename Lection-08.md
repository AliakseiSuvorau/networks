# Лекция 8

### Сабнетинг и супернетинг
* Сабнетинг - разделение доступного сетевого диапазона путем сдвига маски сети
  
> [!TIP]
> **Пример сабнетинга**:
>
> Пусть имеем подсеть `192.168.11.0/24`. Хоти сделать подсети A, B, и C на 100, 50 и 25 хостов соответственно.
> Какие будут маски этих подсетей? Какие минимальный (FA) и максимальный (LA) адреса будут в этих подсетях? Как будет выглядеть broadcast-адрес (BA) в этих подсетях?
>
> *Решение*:
>
> Для начала посчитаем количество битов, нужное для таго, чтобы выдать всем устройствам подсети адрес: $\lceil\log_2N\rceil$, где $N$ - количество хостов.
> Далее вспомним, что все нули - это неизвестный адрес, а все единицы - это broadcast-адрес. Тогда ответим на вопросы:
> 1) * A: `192.168.11.0/25`
>    * FA: `192.168.11.1`
>    * LA: `192.168.11.126`
>    * BA: `192.168.11.127`
> 2) * B: `192.168.11.128/26`
>    * FA: `192.168.11.129`
>    * LA: `192.168.11.190`
>    * BA: `192.168.11.191`
> 3) * C: `192.168.11.192/27`
>    * FA: `192.168.11.193`
>    * LA: `192.168.11.222`
>    * BA: `192.168.11.223`

* Супернетинг - объединение доступного сетевого диапазона путем сдвига маски сети

> [!TIP]
> **Пример супернетинга**:
>
> Пусть имеем подсеть с адресом `192.168.11.0/24`. Хотим сдвинуть маску на 1 бит. Получим `192.168.10.0/23`.

## ICMPv4

### Общая информация

* *Цель* - информирование о проблемах (ошибках) с ip-дейтаграммами, а также диагностика.

> [!NOTE]
> Если возникает ошибка при доставке icmp-сообщения, то icmp-сообщение, говорящее об этой ошибке, не посылается (за исключением некоторых случаев).

* Инкапсулировано в IP под номером 1

### Заголовок icmp

* Тип icmp-сообщения (1 октет)
* Код icmp-сообщения (1 октет)
* Контрольная сумма (2 октета) - подсчитывается как в ip
* Данные

### Основные типы icmp-сообщений

#### Destination unreachable - 3
* Коды
  * 0 - net unreachable
  * 1 - host unreachable
  * 2 - protocol unreachable (к примеру, запихиваем протокол транспортного уровня хосту, который не умеет его обрабатывать)
  * 3 - port unreachable (послали сообщение на порт, который никто не слушает. Посылается хостом)
  * 4 - fragmentation needed and DF set
  * 5 - source route failed (в современных сетях не используется)

> [!NOTE]
> Код 3 используется из основных протоколов только в UDP.

> [!NOTE]
> Файерволы могут не посылать сообщения с кодом 3, так как это уменьшает количество портов для атаки.

* Данные
  * Неиспользуемые 32 бита
  * ip-заголовок + 8 октет не доставленной дейтаграммы

#### Time exceeded - 11
* Коды
  * 0 - ttl exceeded in transit
  * 1 - fragment reassembly time exceeded (время ожидания фрагмента дейтаграммы, который не дошел)

* Данные
  * Неиспользуемые 32 бита
  * ip-заголовок + 8 октет не доставленной дейтаграммы

#### Redirect - 5
* Посылается роутером, если он знает более выгодный маршрут
* **Пример**: Имеем хост H и 2 роутера R1 и R2, подключенных к одной LAN. Н хочет послать сообщение R2 и отправляет его R1. Тогда R1 пошлет H icmp-сообщение о том, что можно послать сразу на R1.
* Коды
  * 0 - redirect datagrams for the network
  * 1 - redirect datagrams for the host
  * 2 - redirect datagrams for the type of service and network
  * 3 - redirect datagrams for the type of service and host

> [!NOTE]
> При помощи этого механизма можно перенаправить трафик на прослушивающее устройство, поэтому в современных сетях мы не верим этим сообщениям.

* Данные
  * ip-адреса шлюза, через который предпостительнее доставить дейтаграмму (32 бита)
  * ip-заголовок + 8 октет не доставленной дейтаграммы

#### Echo запросы (8) и Echo ответы (0)
* Код - 0
* Данные
  * Идентификатор - для идентификации соответствия запросов ответам
  * Номер последовательности - увеличиваем для каждого следующего запроса
  * Сами данные
    * Произвольная последовательность октетов, определенных тем, кто отправляет запрос
    * В ответе эта последовательность должна быть продублирована

 ## UDP

 ### Общая информация

 * User Datagram Protocol
 * Самый простой протокол
 * Базовый стандарт - RFC768 (август 1980)

### Задачи

* Реализация дейтаграммного режима передачи в сетях с пакетной адресацией
* Нижележащий протокол - ip
* Ориентирован на транзакционную модель взаимодействия (т.е. логика взаимодействия тут не реализована. За нее отвечают вышележащие протоколы)
* **Не** гарантирует:
  * Доставку пакетов
  * Защиту от дубликатов
  * Борьбу с перегрузками

> [!NOTE]
> Когда мы говорим об ip-протоколах, то используем термин дейтаграммы, о udp-протоколах - пользовательские дейтаграммы, о tcp-протоколах - сегменты, об Ethernet - кадр+преамбула+... . Пакет - более общий термин.

### Формат пакета

* Порт источника ( 16 бит)
* Порт приемника (16 бит)
* Длина (16 бит)
* Контрольная сумма (16 бит)
* Данные

#### Порт

* Определяет некоторое сетевое соединение
* Назначаемые
  * Системные: 0 - 1023
  * Пользовательские: 1024 - 49151
* Динамические: 49152 - 65535

> [!NOTE]
> * Порт 0 нельзя назначать
> * Граничные порты назначать не рекомендуется, но и не запрещается
> * Порт 80 - http (тут находится web-сервер. Он один, но на нем может работать несколько web-приложений)
> * Порт 53 - DNS

* Назначаемые порты:
  * Назначенные - закрепленные за каким-то широко распространенным сервисом
  * Неназначенные - доступные для назначения
  * Зарезервированные (0, 1023, 1024, ...)

#### Длина заголовка

* Общий размер дейтаграммы в байтах
* Минимальный - 8
* Максимальный - $2^{16}-1=65527$, но на деле из этой цифры еще вычитается длина ip-заголовка, т.е. 65507

#### Контрольная сумма

* Вычисляется по псевдозаголовку, загловку UDP и пользовательским данным
* Алгоритм:
  * Суммируем 16-битные числа (если надо - дополняем нулями) с переносом в младшие разряды
  * Берем обратный код (дополнение каждого бита до 1)
* Если равна 0, то считается, что контрольная сумма не вычислялась
* Псевдозаголовок
  * Источник (32 бита)
  * Получатель (32 бита)
  * Нули (8 битов)
  * Протокол (8 битов)
  * Длина UDP (16 битов)

> [!NOTE]
> Псевдозаголовок нигде не передается и нигде не хранится. Он просто создается на месте и используется при подсчете суммы.

## UDP-Lite
