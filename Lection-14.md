# Доп. лекция

## Содержание

* IPSec
  * Проблемы IPv4
  * Задачи информационной безопасности
  * Стек протоколов IPSec
  * Инфраструктура IPSec
  * AH
  * ESP
  * ISAKMP

## IPSec

### Проблемы IPv4

* Подделка пакетов
  * отправитель выдает себя за другого
  * можно изменить пакет при передаче
* Повторы пакетов
  * атака повторами
* Перехват пакетов
  * данные передаются в открытом виде

### Задачи информационной безопасности

* Конфиденциальность (шифрование)
* Взаимная аутентификация
* Защита от целенаправленного изменения данных (криптографические хеши)
* Защита от атак повторами

> [!TIP]
> Пример атаки повторами - когда копируем вализную маршрутную таблицу, и потом позже посылаем ее в сеть.

> [!NOTE]
> Алгоритмы IPSec прозрачны с точки зрения конечных устройств, т.е. они даже не замечают).

### Стек протоколов IPSec

* Оцпионален для IPv4, но обязателен для IPv6 (с пометкой, что если уж совсем никак нельзя реализовать, то так уж и быть)
* Содержит 3 основных протокола:
  * ISAKMP - Internet Security Association Key Managment Protocol (по-другому, IKE - Internet Key Exchange)
    * Договариваемся, что и как будем защищать, а также о ключах
  * AH - Authentication Header
    * Не умеем шифровать данные (нет конфиденциальности), но делаем аутентификацию
  * ESP - Encapsulated Security Payload
    * Делаем и аутентификацию, и шифрование

### Инфраструктура IPSec

* Политики ip-безопасности
  * Есть 3 стандартные политики (может быть определено несколько, но активная только одна)
  * *Политика* - свод некоторых правил
  * *Правило* - фильтр и действие, которое надо совершить с трафиком, если они подошли под критерий (заблокировать/пропустить/запросить общение по безопасному каналу...)
  * **Клиентская** - мы не требуем безопасной коммуникации, но если от нас потребуют ее, то готовы согласовать
  * **Серверная** - требуем от хостов работать по безопасному каналу связи, но если кто-то из хостов не может, то работаем с ним по небезопасному
  * **Безопасная серверная** - требуем от хостов работать по безопасному каналу связи, а если кто-то из хостов не может, то отказываемся с ним работать

### AH

* Обеспечивает:
  * гарантию целостности данных (т.е. что данные не заменены при транзите)
  * гарантию, что данные получены от валидного источника
  * защиту от атак повторами (по умолчанию включена, но можно отключить)

> [!NOTE]
> Если решаем общаться по защищенному каналу, то сначала работает ISAKMP, затем - AH и/или ESP.
  
* Режимы работы:
  * Между двумя хостами
  * Между двумя шлюзами
  * Между шлюзом и хостом

* Обеспечиваем защиту:
  * пользовательских данных
  * части ip-заголовка (из-за этого, правда, могут возникнуть проблемы с NAT-шлюзами, т.к. они меняют адреса в заголовках)

* Следует сразу за ip-заголовком (номер протокола - 51)
* Формат заголовка:
  * 8 бит - next header - номер вложенного протокола
  * 8 бит - payload len - длина данных в 4-октетных блоках
  * 16 бит - зарезервированы
  * 32 бита - Security Parameter Index - какой набор ключей и протоколов используем
  * 32 бита - Sequence Number - против атак повторами (м.б. 64-битным, если используем Extended Sequence Number. Это сделано для более быстрых сетей, чтобы при переполнении по модулю можно было все еще отследить вопросы-ответы)
  * Identity Check Value - криптографические коды для проверки целостности (Код считается по ip-заголовку, AH-заголовку и всем данным, которые идут после него)

* Режимы:
  * Транспортный: защищаем непосредственно данные. При этом в ip-заголовке меняется только код нижележащего протокола на 51, затем идет AH-заголовок, затем TCP-заголовок, после чего данные.
    (Считаем, что ни AH-заголовок, ни TCP-заголовок, ниданные не меняются в процессе передачи, однако, некоторые поля в ip-заголовке могут подвергаться изменениям (TTL, Checksum). Эти поля в расчет кодов не включаем)
  * Туннельный: берем всю ip-дейтаграмму, помещаем ее после AH-заголовка и формируем новый ip-заголовок перед AH-заголовком. Посчет кодов также. Проблемы при проходе через NAT

* Защита от повторов
  * Используем механизм скользящего окна. Имеем еще одно окно, расположенное начиная с первого неаутентифицированного фрагмента, и распространяющееся на длину окна
  * Пакеты, попадающие в окно и не полученные ранее, воспринимаются получателем
  * Игнорируем все, что за пределами окна

### ESP

* Все то же самое, что и  AH, но добавляем еще и конфиденциальность
* Формат заголовка
  * 32 бита - Security Parameter Index - какой набор ключей и протоколов используем
  * 32 бита - Sequence Number - против атак повторами
  * Данные (могут включать padding случайной длины. Это делается для защиты от атак подсчетом длин)
  * Отступ (для выравнивания)
  * 8 бит - длина отступа
  * 8 бит - next header - номер вложенного протокола
  * Identity Check Value - криптографические коды для проверки целостности

> [!NOTE]
> Атака подсчетом длины сообщения - атака, при которой хакеры узнают длину определенных сообщений, которые могут значить что-то конкретное (к примеру, если сообщение длиной N битов, то это сообщение о том, что выпущены
> баллистические ракеты).

* Режимы:
  * Транспортный
  * Туннельный

> [!IMPORTANT]
> Изначальный ip-заголовок никак не защищается.

### ISAKMP

* Есть 2 версии

#### v1

* Режимы:
  * Фаза 1: установление бузопасного канала связи для дальнейшего функционирования архитектуры IPSec
  * Фаза 2: установление безопасных каналов связи для конкретных защищаемых сервисов

* Методы аутентификации
  * Разделяемый секрет (используется для тестирования IPSec, на малом количестве хостов)
  * Kerberos
  * Центры сертификатов (*рекомендуемое*)

#### v2

* Поддержка современной криптографии
* Упрощение механизма установления соединения
* Повышение стабильности
* Поддержка дополнительных протоколов транспортного уровня (к примеру - SCTP)
* Защита от DoS-атак
