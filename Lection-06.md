# Лекция 6

## Содержание

* [Internet protocol v4](https://github.com/AliakseiSuvorau/networks/blob/master/Lection-06.md#internet-protocol-v4)
  * Стандарты
  * Задачи IPv4
  * Ограничения IPv4
  * Адресация
  * Маска сети
  * Классы адресов
  * Способы получения ip-адреса
  * Заголовок ip-протокола

## Internet protocol v4

### Стандарты

* RFC791 - основной, тут появился IPv4
* RFC792 - появление icmp

### Задачи IPv4

* Обеспечение передачи блоков данных (*дейтаграмм*) от отправителя к получателю по ip-адресу
* Обеспечение механизма фрагментации и сборки дейтаграмм для передачи через сети с меньшим минимальным размером кадра

> [!IMPORTANT]
> Гарантируется, что дейтаграммы одного пакета соберутся в правильный пакет после пересылки, однако нет гарантии, что при передаче нескольких пакетов по частям части первого пакета придут раньше частей последующих.

### Ограничения IPv4

* Нет механизмов обеспечения надежности доставки данных
* Нет механизмов управления потоком данных
* Нет механизмов гарантии передачи дейтаграмм по порядку

> [!NOTE]
> На канальном уровне что-то делаем для обеспечения отсутствия перегрузки, но этого не достаточно.

> [!NOTE]
> Можем послать специальный пакет, говорящий о том, что нам посылают слишком много данных (см. TCP)

### Адресация

* IPv4 имеет размер 4 октета
* Логически разделяется на адрес сети и номер хоста
  * Классы адресов (легаси)
  * Маска сети

### Маска сети

* Способы задания:
  * В виде 4-х октетов (избыточная форма):
    * Адрес: 10.0.0.0
    * Маска сети: 255.0.0.0
  * В нотации CINDR: 10.0.0.0/8

> [!IMPORTANT]
> Хосты из одного широковещательного домена, но с адресами из разных сетей, не смогут взаимодействовать на сетевом уровне без посредника (маршрутизатора).
> При посылке пакета будем указывать mac-адрес роутера.
> Таблица маршрутизации в роутере заполняется статически или динамически:
> * Статически - ручками
> * Динамически - маршрутизаторы могут обмениваться информацией посредством специальных протоколов
>
> Для того, чтобы понять, куда отправлять пакет дальше, роутер ищет нужный ip-адрес (он его перет из пакет) в своей таблице маршрутизации.
> Если в ней не находится нужного адреса, то роутер отбрасывает пакет, посылая icmp-пакет о том, что доставить не удалось

> [!NOTE]
> Единицы в маске означают часть, где находится адрес сети, нули - номера хоста.

* Зарезервированные адреса:
  | Адрес          | Назначение                                                                                                                                 |
  |----------------|--------------------------------------------------------------------------------------------------------------------------------------------|
  | 0.0.0.0/8      | Хост-отправитель из нашей сети (не используется)                                                                                           |
  | 10.0.0.0/8     | Блок адресов для частных сетей (не маршрутизируются в интернет)                                                                            |
  | 127.0.0.0/8    | Блок адресов для использования внутри хоста. Не должны появляться в сети                                                                   |
  | 169.254.0.0/16 | Блок адресов для адресации в локальной сети. Используются для автоматического самоназначения адреса                                        |
  | 172.16.0.0/12  | Блок адресов для частных сетей (не маршрутизируются в интернет)                                                                            |
  | 192.0.2.0/24   | Блок адресов для использования в документации (т.е. можно указывать в общедоступных документах без опасности, что кто-то по нему перейдет) |
  | 192.88.99.0/24 | Блок адресов для преобразования IPv6 в IPv4                                                                                                |
  | 192.168.0.0/16 | Блок адресов для частных сетей (не маршрутизируются в интернет)                                                                            |
  | 198.18.0.0/15  | Для тестирования производительности                                                                                                        |

> [!NOTE]
> Блоков для частных сетей 3 штуки - в соответствии с классами A, B и C

> [!IMPORTANT]
> Автоматическое самоназначение адреса работает, когда сетевая карта по каким-то причинам (к примеру, неисправности) не может получить от DHCP ip-адрес.
> В таком случае адрес выбирается случайно из этой сети, после чего с помощью Gratuitous ARP проверяется, есть ли такой адрес в сети.
> С таким адресом не получится выйти в интернет, однако можно общаться с товарищами по несчастью.

### Классы адресов

| Класс | Старшие биты | Информация                                                                                                                                             |
|-------|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| A     | 0XXXX...     | 126 различных сетей (0 не используется, 127 - зарезервировано), $2^{24}-2$ хостов                                                                      |
| B     | 10XXX...     | Наибольший номер сети: 191.255.0.0, $2^{16}-2$ хостов                                                                                                  |
| C     | 110XX...     | Наибольший номер сети: 223.255.255.0, $2^8-2$ хостов                                                                                                   |
| D     | 1110X...     | Multicast                                                                                                                                              |
| E     | 1111X...     | Зарезервирован, не используется, за исключением 255.255.255.255 - может использоваться в качестве адреса назначения, не должен покидать локальной сети |

> [!NOTE]
> Классы отвечают, какая доля адреса отвечает за номер сети, а какая - за номер хоста.

> [!NOTE]
> Ограничения при назначении адресов хостам:
> * 0 - определяет адрес сети, на должен назначаться хостам
> * -1 - широковещательный адрес для конкретной сети, доставляем всем хостам, используется только в качестве адреса назначения

**Класс D**

* 224.0.0.0/24 - для локального использования, не передаются за пределы локальной сети
  * 224.0.0.5 - все маршрутизаторы
* 239.0.0.0/8 - для использования внутри домена, не выйдет за пределы административного домена

### Способы получения ip-адреса

* Статический (вручную)
* Динамический децентрализованный
  * APIPA
* Динамический централизованный
  * BOOTP (устарел)
  * DHCP (на основе BOOTP)
* Комбинированный
  * К примеру, предпочитаем DHCP, но если он не доступен, то используем что-то другое

### Заголовок ip-протокола

| Размер | Поле | Описание |
|--------|------|----------|
| 4 бита | Версия | Для IPv4 значение этого поля - 4 |
| 4 бита | Длина заголовка | Размер заголовка в 4-октетных блоках. Заголовок может быть переменной длины (см. параметры). Нормальное значение - 5 |
| 8 бит  | Тип обслуживания | Описание трафика с точки зрения того, что делаем с данными. 0-2 биты - приоритет, 3 бит - чувствительность к задержкам (0 - нормальная, 1 - чувствительная), 4 бит - требование к пропускной способности (0 - низкая, 1 - высокая), 5 бит - требование к надежности канала (0 - нормальное, 1 - надежное), 6-7 биты - зарезервированы |
| 16 бит | Идентификатор | см. [Лекцию 7](https://github.com/AliakseiSuvorau/networks/blob/master/Lection-07.md#фрагментация) |
| 3 бита | Флаги | см. [Лекцию 7](https://github.com/AliakseiSuvorau/networks/blob/master/Lection-07.md#фрагментация) |
| 13 бит | Смещение фрагмента | см. [Лекцию 7](https://github.com/AliakseiSuvorau/networks/blob/master/Lection-07.md#фрагментация) |
| 8 бит  | TTL | Time to live. Это счетчик, в котором записано, через сколько маршрутизаторов может пройти пакет прежде чем очередной маршрутизатор его убьет |
| 8 бит  | Протокол | Что будет внутри ip-сообщения (icmp, tcp, udp, ...) |
| 16 бит | Проверочная сумма заголовка | |
| 32 бита | Адрес отправителя | |
| 32 бита | Адрес получателя | |
| 0 - 40 байт | Параметры | Не используется |
| до 65535 байт минус длина заголовка | Данные | |

> [!NOTE]
> В отличие от заголовка пакета Ethernet, в заголовке ip-пакета сначала идет адрес отправителя, а потом адрес получателя.

> [!NOTE]
> TTL нужно, чтобы пакет не крутился бесконечно по кольцу маршрутизации (такое может случиться из-за ошибки в конфигурации).
> Когда пакет убивается, то маршрутизатор отправляет обратно icmp-пакет, сообщающий об этом.
