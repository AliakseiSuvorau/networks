# Лекция 10

## TCP (Transmission Control Protocol)

### Общая информация

* Основной стандарт: RFC 793
* Работает поверх ip

### Задачи и характеристики TCP

* Протокол с установлением соединения
  * Обмен начальными параметрами, которые определяют режим функционирования соединения
  * Также есть алгоритм нормального завершения соединения
* Двунаправленная передача данных в рамках соединения
  * Передача в одну сторону независимо от передачи в другую сторону
* Множество соединений
  * Соединения определяется парой id абонентов
* Надежная передача данных
  * Либо передадим сообщение, либо поймем, что он оне дошло
  * Получаем отклик о том, что сообщение получило, или по истечении таймаута происходит перепосылка

> [!NOTE]
> В UDP icmp-сообщение может быть заблокировано и может не дойти.

* Подтверждение получения данных
* Управление средуой передачи данных
  * Смотрим на возможности сети и не передаем много
* С потоковой передачей данных
* Передаем произаольные данные
  * Не имеющие определенной структуры данные
  * Может быть такое, что TCP сожмет несколько отдельных сообщений в одно, или одно большое сообщение разделит на части вне зависимости от того, где эти все сообщения изначально начинались и кончались

**Сегменты** - единицы передаваемых через TCP данных.

### Формат заголовка

| Размер в битах | Название поля | Информация |
|-|-|-|
| 16 | src port | |
| 16 | dst port | |
| 32 | Sequence Number | Как смещение в ip, но это номер бита в рамках потока передачи данных |
| 32 | Acknowledgment Number | Номер последовательности, ожидаемый отправителем в следующий раз. Относится в параллельному потоку "в другую сторону". Рассматривается только если выставлен флаг ACK |
| 4 | Data Offset | Из-за опций заголовок имеет переменную длину. Сдвиг считается от начала заголовка в 4-октетных блоках |
| 6 | | Зарезервированы. Иногда здесь указываются дополнительные флаги |
| 6 | Флаги | |
| 16 | Окно | Размер принимающего буфера |
| 16 | Checksum | |
| 16 | Urgent pointer | Указывает сдвиг в данных до "важных данных", которые стоит обработать раньше остальных. Рассматривается только елси выставлен флаг URG. Легаси |
| 24 | Опции | |
| 8 | Отступ | |
| | Данные | |

> [!NOTE]
> Пусть у нас будет такой порядок доставки сегментов:
> | 1 | 2 | | 4 | 5 |
> |-|-|-|-|-|
> 
> То есть 3 сегмент не получен. Тогда в Acknowledgement number будет стоять номер бита, с которого начинается третий сегмент.

> [!NOTE]
> В случае, если не получин какой-то сегмент, то придется пересылать заново все сегменты.

> [!NOTE]
> Если при указании смещения возникает переполнение, то берем по модулю.

> [!NOTE]
> Окно вмещает не больше чем $2^{16}$ битов, что мало. Поэтому появляется опция с масштабом окна.

### Флаги
Идут в таком порядке:
* URG
  * Лучше не пользоваться, т.к. промежуточные устройства могут убирать этот флаг
  * Указывает, что в Urgent pointer находится значение
* ACK
  * Указывает, что в Acknowledgment Number находится значение
* PSH
  * Изначально: в сообщении находятся важные данные, которые нельзя задерживать
  * Сейчас: в момент передачи этих данных в буфере отправителя было пусто

Флаги, связанные с установкой и разрывом соединения:
* RST
  * Отказ от соединения
  * Соединение не может быть установлено
  * Обрываем соединение
* SYN
  * Для установки соединения
* FIN
  * Указывает, что больше нет данных и можем вежливо закрывать соединение
  * После этого мы не можем слать ничего кроме подтверждений о получении сообщений
  * А наш партнер может слать что угодно
